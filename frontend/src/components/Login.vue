<template>
  <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
      <div>
        <div class="mx-auto h-24 w-24 flex items-center justify-center">
          <img src="/logo.svg" alt="VHM24R Hub" class="h-20 w-20" />
        </div>
        <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
          VHM24R Hub
        </h2>
        <p class="mt-2 text-center text-sm text-gray-600">
          –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏
        </p>
      </div>

      <div class="mt-8 space-y-6">
        <!-- –û–±—ã—á–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-center mb-6">
            <div class="mx-auto h-16 w-16 flex items-center justify-center rounded-full bg-green-500 mb-4">
              <span class="text-white text-2xl">üîë</span>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">
              –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
            </h3>
            <p class="text-sm text-gray-500">
              –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞
            </p>
          </div>
          
          <form @submit.prevent="handleLogin" class="space-y-4">
            <div>
              <label for="username" class="block text-sm font-medium text-gray-700">
                –õ–æ–≥–∏–Ω
              </label>
              <input
                id="username"
                v-model="loginForm.username"
                type="text"
                required
                class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω"
              />
            </div>
            
            <div>
              <label for="password" class="block text-sm font-medium text-gray-700">
                –ü–∞—Ä–æ–ª—å
              </label>
              <input
                id="password"
                v-model="loginForm.password"
                type="password"
                required
                class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
              />
            </div>
            
            <div>
              <button
                type="submit"
                :disabled="loginLoading"
                class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <span v-if="loginLoading" class="mr-2">
                  <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                </span>
                {{ loginLoading ? '–í—Ö–æ–¥...' : '–í–æ–π—Ç–∏' }}
              </button>
            </div>
            
            <div v-if="loginError" class="text-red-600 text-sm text-center">
              {{ loginError }}
            </div>
          </form>
          
          <div class="mt-4 text-center">
            <p class="text-xs text-gray-500">
              –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ: admin / admin123
            </p>
          </div>
        </div>

        <!-- Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-center">
            <div class="mx-auto h-16 w-16 flex items-center justify-center rounded-full bg-blue-500 mb-4">
              <span class="text-white text-2xl">üì±</span>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">
              –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram
            </h3>
            <p class="text-sm text-gray-500 mb-6">
              –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏—Å—Ç–µ–º–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Telegram –±–æ—Ç
            </p>
            
            <div class="space-y-4">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center justify-center space-x-2 mb-2">
                  <span class="text-blue-600 font-medium">@vhm24rbot</span>
                </div>
                <p class="text-xs text-blue-600">
                  –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –±–æ—Ç —Å–∏—Å—Ç–µ–º—ã VHM24R
                </p>
              </div>
              
              <div class="text-left space-y-2 text-sm text-gray-600">
                <div class="flex items-start space-x-2">
                  <span class="text-blue-500 font-bold">1.</span>
                  <span>–ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ <strong>@vhm24rbot</strong> –≤ Telegram</span>
                </div>
                <div class="flex items-start space-x-2">
                  <span class="text-blue-500 font-bold">2.</span>
                  <span>–ù–∞–∂–º–∏—Ç–µ <strong>/start</strong> –¥–ª—è –Ω–∞—á–∞–ª–∞</span>
                </div>
                <div class="flex items-start space-x-2">
                  <span class="text-blue-500 font-bold">3.</span>
                  <span>–ü–æ–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –¥–æ—Å—Ç—É–ø</span>
                </div>
                <div class="flex items-start space-x-2">
                  <span class="text-blue-500 font-bold">4.</span>
                  <span>–î–æ–∂–¥–∏—Ç–µ—Å—å –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</span>
                </div>
                <div class="flex items-start space-x-2">
                  <span class="text-blue-500 font-bold">5.</span>
                  <span>–ü–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ö–æ–¥–∞</span>
                </div>
              </div>
              
              <a 
                href="https://t.me/vhm24rbot" 
                target="_blank"
                class="inline-flex items-center justify-center w-full px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                <span class="mr-2">üì±</span>
                –û—Ç–∫—Ä—ã—Ç—å Telegram –±–æ—Ç
              </a>
            </div>
          </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ -->
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">
            –û —Å–∏—Å—Ç–µ–º–µ VHM24R
          </h3>
          <div class="space-y-3 text-sm text-gray-600">
            <div class="flex items-start space-x-3">
              <span class="text-green-500">‚úÖ</span>
              <span>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ 12 —Ñ–æ—Ä–º–∞—Ç–∞—Ö (CSV, Excel, PDF –∏ –¥—Ä.)</span>
            </div>
            <div class="flex items-start space-x-3">
              <span class="text-green-500">‚úÖ</span>
              <span>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</span>
            </div>
            <div class="flex items-start space-x-3">
              <span class="text-green-500">‚úÖ</span>
              <span>–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</span>
            </div>
            <div class="flex items-start space-x-3">
              <span class="text-green-500">‚úÖ</span>
              <span>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã</span>
            </div>
            <div class="flex items-start space-x-3">
              <span class="text-green-500">‚úÖ</span>
              <span>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö</span>
            </div>
          </div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <div v-if="authStatus" class="bg-white rounded-lg shadow p-6">
          <div class="text-center">
            <div v-if="authStatus === 'checking'" class="space-y-3">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
              <p class="text-sm text-gray-600">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</p>
            </div>
            
            <div v-else-if="authStatus === 'success'" class="space-y-3">
              <div class="mx-auto h-8 w-8 flex items-center justify-center rounded-full bg-green-100">
                <span class="text-green-600">‚úÖ</span>
              </div>
              <p class="text-sm text-green-600 font-medium">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</p>
              <p class="text-xs text-gray-500">–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ —Å–∏—Å—Ç–µ–º—É...</p>
            </div>
            
            <div v-else-if="authStatus === 'error'" class="space-y-3">
              <div class="mx-auto h-8 w-8 flex items-center justify-center rounded-full bg-red-100">
                <span class="text-red-600">‚ùå</span>
              </div>
              <p class="text-sm text-red-600 font-medium">–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</p>
              <p class="text-xs text-gray-500">{{ errorMessage }}</p>
              <button 
                @click="authStatus = null"
                class="text-blue-600 hover:text-blue-800 text-sm"
              >
                –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
              </button>
            </div>
          </div>
        </div>

        <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
        <div class="text-center">
          <p class="text-xs text-gray-500">
            –í–æ–ø—Ä–æ—Å—ã –ø–æ –¥–æ—Å—Ç—É–ø—É? –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: 
            <a href="https://t.me/Jamshiddin" class="text-blue-600 hover:text-blue-800">
              @Jamshiddin
            </a>
          </p>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, onMounted } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import api from '../services/api'

export default {
  name: 'Login',
  props: {
    token: String,
    uid: String,
    sessionToken: String,
    adminToken: String
  },
  setup(props) {
    const router = useRouter()
    const route = useRoute()
    const authStatus = ref(null)
    const errorMessage = ref('')
    
    // –û–±—ã—á–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    const loginForm = ref({
      username: '',
      password: ''
    })
    const loginLoading = ref(false)
    const loginError = ref('')

    const handleLogin = async () => {
      loginLoading.value = true
      loginError.value = ''
      
      try {
        const response = await api.post('/api/v1/auth/login', {
          username: loginForm.value.username,
          password: loginForm.value.password
        })

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        localStorage.setItem('token', response.data.access_token)
        localStorage.setItem('user', JSON.stringify(response.data.user))

        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ —Å–∏—Å—Ç–µ–º—É
        router.push('/')

      } catch (error) {
        loginError.value = error.response?.data?.detail || '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'
      } finally {
        loginLoading.value = false
      }
    }

    const checkTelegramAuth = async () => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–æ–∫–µ–Ω –≤ URL (–∏–∑ Telegram –±–æ—Ç–∞)
      const token = props.token || route.query.token
      const uid = props.uid || route.query.uid

      if (token && uid) {
        authStatus.value = 'checking'
        
        try {
          const response = await api.post('/auth/telegram/verify', {
            token,
            uid
          })

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          localStorage.setItem('token', response.data.access_token)
          localStorage.setItem('user', JSON.stringify(response.data.user))

          authStatus.value = 'success'

          // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ —Å–∏—Å—Ç–µ–º—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
          setTimeout(() => {
            router.push('/')
          }, 2000)

        } catch (error) {
          authStatus.value = 'error'
          errorMessage.value = error.response?.data?.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
        }
      }
    }

    const checkSessionAuth = async () => {
      if (props.sessionToken) {
        authStatus.value = 'checking'
        
        try {
          const response = await api.post('/auth/session', {
            session_token: props.sessionToken
          })

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          localStorage.setItem('token', response.data.access_token)
          localStorage.setItem('user', JSON.stringify(response.data.user))

          authStatus.value = 'success'

          // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ —Å–∏—Å—Ç–µ–º—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
          setTimeout(() => {
            router.push('/')
          }, 1000)

        } catch (error) {
          authStatus.value = 'error'
          errorMessage.value = error.response?.data?.detail || '–°—Å—ã–ª–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –∏–ª–∏ –∏—Å—Ç–µ–∫–ª–∞'
        }
      }
    }

    const checkAdminAuth = async () => {
      if (props.adminToken) {
        authStatus.value = 'checking'
        
        try {
          const response = await api.post('/auth/admin', {
            admin_token: props.adminToken
          })

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          localStorage.setItem('token', response.data.access_token)
          localStorage.setItem('user', JSON.stringify(response.data.user))

          authStatus.value = 'success'

          // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ —Å–∏—Å—Ç–µ–º—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
          setTimeout(() => {
            router.push('/')
          }, 1000)

        } catch (error) {
          authStatus.value = 'error'
          errorMessage.value = error.response?.data?.detail || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –∏–ª–∏ –∏—Å—Ç–µ–∫–ª–∞'
        }
      }
    }

    onMounted(() => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
      const token = localStorage.getItem('token')
      if (token) {
        router.push('/')
        return
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      if (props.sessionToken) {
        checkSessionAuth()
      } else if (props.adminToken) {
        checkAdminAuth()
      } else {
        checkTelegramAuth()
      }
    })

    return {
      authStatus,
      errorMessage,
      loginForm,
      loginLoading,
      loginError,
      handleLogin
    }
  }
}
</script>
